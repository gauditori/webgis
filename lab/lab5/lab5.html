<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OpenLayers Basemap Switcher with WMS Layer</title>
  <!-- Use the UMD build from jsDelivr (dist) so `ol` is available as a global. -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map {
      width: 100%;
      height: 100vh; /* fill the viewport */
    }
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.95);
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.25);
      font-family: Arial, sans-serif;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div class="controls">
    <div style="margin-bottom:8px;">
      <strong>Basemap</strong><br>
      <label><input type="radio" name="basemap" value="osm" checked> OSM Basemap</label><br>
      <label><input type="radio" name="basemap" value="esri"> ESRI Imagery</label>
    </div>
    <div>
      <label><input type="checkbox" id="wmsToggle" checked> WMS Layer (topp:states)</label>
    </div>
  </div>

  <div id="map"></div>

  <!-- Load the OpenLayers UMD build from the dist folder so `ol` is defined globally -->
  <script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>

  <script>
    // Wrap initialization to ensure both the OpenLayers script and the DOM are ready.
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof ol === 'undefined') {
        console.error('OpenLayers (ol) is not defined. Check the CDN path.');
        alert('OpenLayers failed to load. See console for details.');
        return;
      }

      // Base layers
      const osmLayer = new ol.layer.Tile({
        source: new ol.source.OSM(),
        visible: true
      });

      const esriLayer = new ol.layer.Tile({
        source: new ol.source.XYZ({
          // Use Esri World Imagery tiles
          url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
        }),
        visible: false
      });

      // WMS Layer (topp:states)
      const wmsLayer = new ol.layer.Tile({
        source: new ol.source.TileWMS({
          url: 'https://ahocevar.com/geoserver/wms',
          params: {
            'LAYERS': 'topp:states',
            'TILED': true,
            'FORMAT': 'image/png'
          },
          serverType: 'geoserver',
          // Provide a crossOrigin so tiles can be fetched in most hosts
          crossOrigin: 'anonymous'
        }),
        visible: true
      });

      // Build map options; only set controls if ol.control.defaults exists and is a function
      const mapOptions = {
        target: 'map',
        layers: [osmLayer, esriLayer, wmsLayer],
        view: new ol.View({
          center: ol.proj.fromLonLat([-98.5795, 39.8283]), // continental US
          zoom: 4
        })
      };

      if (ol.control && typeof ol.control.defaults === 'function') {
        // Some OL builds expose ol.control.defaults(); others don't. Guard the call.
        try {
          mapOptions.controls = ol.control.defaults();
        } catch (err) {
          console.warn('ol.control.defaults() threw an error; falling back to default controls.', err);
        }
      } else {
        // Don't set controls explicitly - OpenLayers will use its defaults when not provided.
        console.info('ol.control.defaults() not available; letting OpenLayers apply default controls.');
      }

      // Map initialization - center on the continental US
      const map = new ol.Map(mapOptions);

      // Basemap switcher (radio buttons)
      document.querySelectorAll('input[name="basemap"]').forEach(radio => {
        radio.addEventListener('change', (event) => {
          const value = event.target.value;
          osmLayer.setVisible(value === 'osm');
          esriLayer.setVisible(value === 'esri');
        });
      });

      // WMS layer toggle (checkbox)
      const wmsToggle = document.getElementById('wmsToggle');
      wmsToggle.addEventListener('change', (event) => {
        wmsLayer.setVisible(event.target.checked);
      });

      // Helpful debug info in console
      console.log('Map initialized. ol.VERSION (if available):', (ol && ol.VERSION) ? ol.VERSION : 'unknown');
    });
  </script>
</body>
</html>
